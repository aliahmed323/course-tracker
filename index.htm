<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù…ØªØ§Ø¨Ø¹Ø© ÙƒÙˆØ±Ø³Ø§Øª (Firebase)</title>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<style>
  /* --- Base Styles (No Change) --- */
  :root{
    --bg:#0f172a; --card:#111827; --muted:#1f2937;
    --accent:#3b82f6; --accent2:#22c55e; --warn:#f59e0b;
    --danger:#ef4444; --text:#e5e7eb; --sub:#cbd5e1;
    --warn-rgb: 245, 158, 11;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:linear-gradient(180deg,#0b1226,#0f172a 50%,#0b1226); color:var(--text); font-family:"Tajawal",system-ui,Arial; font-size:18px; padding-top: 80px; }
  header{ position:fixed; top:0; right:0; left:0; z-index:50; background:rgba(15,23,42,.85); backdrop-filter:blur(8px); border-bottom:1px solid #1e293b; padding: 12px 0; height: 80px; }
  .header-container { max-width:1200px; margin:auto; padding:0 16px; display: flex; justify-content: space-between; align-items: center; gap: 16px; }
  h1{ margin:0; font-size: 22px; white-space: nowrap; }
  .welcome-message { color: var(--warn); font-weight: bold; margin-right: 10px; font-size: 16px; }

  .container{max-width:1200px; margin:auto; padding:16px;}
  .subject-selector-container { display: flex; gap: 8px; align-items: center; flex-grow: 1; max-width: 500px; }
  .subject-selector-container select { flex-grow: 1; padding: 8px 12px; font-size: 14px; }
  #addSubjectBtn { padding: 8px 12px; min-width: 40px; font-size: 16px; flex-shrink: 0; }
  .kpis{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .kpi{background:#0c1a2e; border:1px solid #173457; padding:8px 12px; border-radius:10px; font-size:16px; text-align: center;}
  .progress-stack { display: grid; gap: 8px; margin-top: 12px; }
  .progress-label { font-size: 14px; color: var(--sub); }
  .bar{height:12px; background:#0b1220; border-radius:999px; overflow:hidden; border:1px solid #1f2a40}
  .bar > span{ display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); width:0%; transition: width 0.3s ease; }
  #blueprintBar > span { background:linear-gradient(90deg,var(--warn), #f00); }
  .toolbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
  button, select { background:linear-gradient(180deg,#0f2a4a,#0a1f3b); color:#dbeafe; border:1px solid #1e3a5f; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; font-size:16px; font-family: inherit; }
  button.secondary{background:#121a2b; color:#cbd5e1; border:1px solid #263146}
  button.danger{background:#2a0f16; border-color:#5f1e29; color:#fecaca}
  button.warn{background:#3f2c0a; border-color:#854d0e; color:#fef3c7}
  .cards{ display:grid; grid-template-columns:1fr; gap:16px; margin:16px auto; }
  .card{ background:linear-gradient(180deg,#0f172a,#0c142a); border:1px solid #18243a; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02); padding: 0; }
  .card-header { padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: nowrap;}
  .card-header:hover { background: rgba(255,255,255,0.03); }
  .card h2{margin:0; font-size:22px; flex-grow: 1;}
  .card-header .chapter-weight { font-size: 20px; font-weight: 700; color: var(--warn); flex-shrink: 0; }
  .card-content { padding: 0 16px 16px; display: grid; gap: 8px; display: none; }
  .row{ display:grid; grid-template-columns: auto auto 1fr auto auto auto; gap: 10px; align-items:center; padding:10px; border-radius:12px; border:1px solid #1a2742; background:#0b1527; font-size:16px; transition: all 0.2s ease; }
  .row.done{border-color:#1f3f2a; background:#0c1f14} .row.partial{border-color:#3a3214; background:#1c1609}
  .star-btn { background: none; border: none; color: var(--sub); font-size: 22px; cursor: pointer; padding: 0 5px; grid-column: 1; }
  .star-btn.active { color: var(--warn); }
  .row .lecture-weight { grid-column: 2; font-size: 14px; font-weight: 700; color: var(--warn); border-left: 2px solid var(--muted); padding-left: 10px; }
  .row .title{ font-weight:700; grid-column: 3; }
  .snooze-btn { grid-column: 4; background: var(--muted); color: var(--sub); border: 1px solid #2e3d55; padding: 6px 8px; border-radius: 8px; font-size: 16px; cursor: pointer; }
  .row label.chip { grid-column: span 1; }
  .row.snoozed { opacity: 0.4; background: #1a202c; } .row.snoozed .title { text-decoration: line-through; }
  .row.snoozed .snooze-btn { background: var(--warn); color: #000; border-color: var(--warn); }
  .chip{ display:inline-flex; align-items:center; gap:8px; background:#072437; color:#c3e4ff; border:1px solid #0b4a70; padding: 6px 10px; border-radius: 8px; font-size:14px; }
  .chip input{transform:scale(1.2); margin-right: 4px;}
  .modal-back{position:fixed; inset:0; background:rgba(2,6,23,.75); backdrop-filter:blur(6px); display:none; align-items:center; justify-content:center; z-index:100;}
  .modal{width:min(900px,92vw); max-height:80vh; overflow:auto; background:#0a1221; border:1px solid #1a2742; border-radius:16px; padding:16px;}
  .modal h3{margin:0 0 8px; font-size:22px} .divider{height:1px; background:#1d2a44; margin:12px 0}
  .footer{color:#9fb3ca; font-size:14px; margin:32px 0 16px; text-align: center; line-height: 1.6;}
  .footer a { color: var(--accent); text-decoration: none; } .footer a:hover { text-decoration: underline; }
  .form-group{margin-bottom:12px;} .form-group label{display:block; margin-bottom:4px; font-size:16px; color:var(--sub);}
  .form-group input, .form-group textarea, .form-group select{ width:100%; background:#0b1527; border:1px solid #1a2742; color:var(--text); padding:8px 12px; border-radius:8px; font-size:16px; }
  .form-group input[type="date"] { padding: 7px 12px; } .form-group textarea{ min-height: 150px; resize: vertical; }
  .planner-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; justify-content: center; }
  .planner-box { background: #0c1a2e; border: 1px solid #173457; border-radius: 10px; padding: 12px 16px; flex-grow: 1; text-align: center; min-width: 150px; position: relative; }
  .planner-box.clickable { cursor: pointer; transition: background-color 0.2s ease; } .planner-box.clickable:hover { background: #173457; }
  .planner-box .label { font-size: 14px; color: var(--sub); margin-bottom: 4px; display: block; }
  .planner-box .value { font-size: 24px; font-weight: 700; color: var(--text); }
  .status-info-icon { font-size: 14px; color: var(--sub); margin-right: 5px; cursor: help; }
  .status-danger { border-color: var(--danger); background: #2a0f16; } .status-danger .value { color: var(--danger); }
  .status-good { border-color: var(--accent2); background: #0c1f14; } .status-good .value { color: var(--accent2); }
  .status-warn { border-color: var(--warn); background: #2a210f; } .status-warn .value { color: var(--warn); }
  .date-picker-hidden { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; border: none; }
  #mainAppContent { display: none; } #userSection { display: none; align-items: center; gap: 10px; }
  #userImg { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent); }
  #userName { font-size: 14px; font-weight: bold; } #logoutBtn { font-size: 14px; padding: 6px 10px; }
  #loginBtn { display: block; }
  #aboutModal .modal-content { line-height: 1.7; }
  #aboutModal .modal-content h4 { color: var(--warn); margin-top: 1.5em; margin-bottom: 0.5em; }
  #aboutModal .modal-content ul { padding-right: 20px; }
  #aboutModal .modal-content code { background: var(--muted); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
  .chapter-progress-container { width: 100px; height: 8px; background: #0b1220; border-radius: 999px; overflow: hidden; border: 1px solid #1f2a40; }
  .chapter-progress-bar { height: 100%; background: linear-gradient(90deg, var(--warn), #ffcc33); width: 0%; transition: width 0.3s ease; }
  .search-container { margin: 16px 0; }
  #searchInput { width: 100%; padding: 12px 16px; font-size: 16px; background: #0c1a2e; border: 1px solid #173457; border-radius: 10px; color: var(--text); }
  .row.highlight { background-color: rgba(245, 158, 11, 0.2); border-color: var(--warn); }
  #starredModal .card { margin-bottom: 12px; padding: 16px;}
  #starredModal .row { grid-template-columns: auto 1fr auto; gap: 15px;}
  #starredModal .completion-status { font-size: 14px; color: var(--sub); text-align: left;}
  #starredModal .completion-status.done { color: var(--accent2); }
  :root { --warn-rgb: 245, 158, 11; }
  #clockDateContainer {
    display: flex;
    gap: 10px;
    align-items: center;
    color: var(--sub);
    font-size: 14px;
    margin-right: auto;
    margin-left: 16px;
    white-space: nowrap;
  }
  #liveClock {
    font-weight: 700;
    color: var(--text);
    background: var(--muted);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 16px;
    letter-spacing: 1px;
  }
  #liveDate {
    font-size: 12px;
  }
  @media (max-width: 600px) {
    #clockDateContainer { display: none; }
  }
  .chapter-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 12px;
    color: var(--sub);
    margin-top: 10px;
    justify-content: flex-end;
  }
  .chapter-stats .stat-item {
    background: #0b1527;
    border: 1px solid #1a2742;
    padding: 2px 6px;
    border-radius: 6px;
  }
  .chapter-stats .stat-item span {
    font-weight: 700;
    color: var(--text);
  }
</style>
</head>
<body>

<header>
  <div class="header-container">
    <div style="display: flex; align-items: center; gap: 16px;">
        <h1 id="headerTitle">Ù…ØªØ§Ø¨Ø¹Ø© ÙƒÙˆØ±Ø³Ø§Øª</h1>
        <span class="welcome-message">Ù…Ø±Ø­Ø¨Ø§Ù‹</span>
    </div>
    <div id="clockDateContainer">
        <span id="liveDate"></span>
        <span id="liveClock"></span>
    </div>
    <div id="authSection" style="display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
        <div id="userSection"> <img id="userImg" src="" alt="User"/> <span id="userName"></span> <button id="logoutBtn" class="secondary">Ø®Ø±ÙˆØ¬</button> </div>
        <button id="loginBtn" class="warn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>
</header>

<main class="container" id="mainAppContent">
  <div class="subject-selector-container"> <select id="subjectSelector"></select> <button id="addSubjectBtn" class="warn">+</button> </div>

  <div class="planner-container">
    <div class="planner-box clickable status-warn" id="daysRemainingBox"> <span class="label">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span> <b id="daysRemaining" class="value">-</b> <input type="date" id="datePickerInput" class="date-picker-hidden"> </div>
    <div class="planner-box clickable" id="totalHoursBox"> <span class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</span> <b id="totalHours" class="value">-</b> </div>
    <div class="planner-box" id="remainingHoursBox"> <span class="label">Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span> <b id="remainingHours" class="value">-</b> </div>
    <div class="planner-box" id="plannerStatusBox"> <span class="label">Ø­Ø§Ù„ØªÙƒ <span id="planStatusInfo" class="status-info-icon" title="">â“</span></span> <b id="planStatus" class="value">-</b> </div>
    <div class="planner-box" id="plannerLecturesBox"> <span class="label">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙŠÙˆÙ…ÙŠØ§Ù‹ (Ù…Ø­Ø§Ø¶Ø±Ø§Øª)</span> <b id="planLecturesPerDay" class="value">-</b> </div>
    <div class="planner-box" id="plannerHoursBox"> <span class="label">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙŠÙˆÙ…ÙŠØ§Ù‹ (Ø³Ø§Ø¹Ø§Øª)</span> <b id="planHoursPerDay" class="value">-</b> </div>
  </div>

  <div class="progress-stack"> <div> <div style="display: flex; justify-content: space-between;"> <span class="progress-label">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</span> <b id="globalBarPct" style="font-size: 14px;">0%</b> </div> <div class="bar"><span id="globalBar"></span></div> </div> <div> <div style="display: flex; justify-content: space-between;"> <span class="progress-label">Ø´Ø±ÙŠØ· Ù†Ø³Ø¨Ø© mcq Ø§Ù„Ø¨Ù„ÙˆØ¨Ø±Ù†Øª</span> <b id="blueprintBarPct" style="font-size: 14px; color: var(--warn);">0%</b> </div> <div class="bar" id="blueprintBar"><span id="blueprintBarSpan"></span></div> </div> </div>
  <div class="search-container"> <input type="search" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø§Ø¶Ø±Ø©..."> </div>
  <div class="toolbar"> <button class="warn" id="manageDataBtn">Ø¥Ø¯Ø§Ø±Ø©</button> <button class="secondary" id="sortBtn">ÙØ±Ø²</button> <button id="showRemaining">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</button> <button class="warn" id="showStarredBtn">Ø§Ù„Ù…ÙØ¶Ù„Ø© â­</button> <button class="secondary" id="expandAll">ÙØªØ­ Ø§Ù„ÙƒÙ„</button> <button class="secondary" id="collapseAll">Ø·ÙŠÙ‘ Ø§Ù„ÙƒÙ„</button> <button id="showAboutBtn">Ø´Ø±Ø­</button> </div>
  <div class="kpis" id="globalKpis" style="margin-top:16px"></div> <div class="cards" id="cards"></div>
  <div class="footer"> Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØµÙ…ÙŠÙ…: Ø¹Ù„ÙŠ Ø§Ø­Ù…Ø¯ | Ù„Ù„ØªÙˆØ§ØµÙ„: <a href="https://t.me/draliturki" target="_blank" rel="noopener noreferrer">@draliturki</a> <br> Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø© Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹. </div>
</main>

<div class="modal-back" id="remainingModalBack"> <div class="modal"> <h3>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h3> <div id="remainingContainer"></div> <div class="divider"></div> <div style="text-align: left;"> <button class="secondary" id="closeRemainingModal">Ø¥ØºÙ„Ø§Ù‚</button> </div> </div> </div>
<div class="modal-back" id="addSubjectModal"> <div class="modal" style="width: min(500px, 90vw);"> <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</h3> <div class="form-group"> <label for="newSubjectNameInput">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:</label> <input type="text" id="newSubjectNameInput"/> </div> <div class="divider"></div> <div style="text-align: left;"> <button class="secondary" id="cancelAddSubject">Ø¥Ù„ØºØ§Ø¡</button> <button id="saveNewSubjectBtn" style="margin-right: 8px;">Ø­ÙØ¸</button> </div> </div> </div>
<div class="modal-back" id="manageModalBack"> <div class="modal" id="manageModalContent"> </div> </div>

<div class="modal-back" id="aboutModal">
  <div class="modal">
    <h3>Ø´Ø±Ø­ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
    <div class="modal-content">
        <p>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…ØªØªØ¨Ø¹ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª!</p>
        <p>Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ØµÙ…Ù… Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¹Ù„Ù‰ ØªÙ†Ø¸ÙŠÙ… Ø¯Ø±Ø§Ø³ØªÙƒ ÙˆØªØªØ¨Ø¹ Ø¥Ù†Ø¬Ø§Ø²Ùƒ Ø¨ÙØ§Ø¹Ù„ÙŠØ©.</p>

        <h4>ğŸ“… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Planner)</h4>
        <ul>
            <li><b>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</b> Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù„Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.</li>
            <li><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª:</b> Ø§Ø¶ØºØ· Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø§Ø¯Ø© (ÙŠØ¯ÙˆÙŠØ§Ù‹).</li>
            <li><b>Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</b> ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªÙŠ ØªØ¯Ø®Ù„Ù‡Ø§ Ø¹Ù†Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.</li>
            <li><b>Ø­Ø§Ù„ØªÙƒ (â“):</b> ÙŠÙ‚Ø§Ø±Ù† Ø¥Ù†Ø¬Ø§Ø²Ùƒ (Ø§Ù„Ø¨Ù„ÙˆØ¨Ø±Ù†Øª) Ø¨Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ.</li>
        </ul>

        <h4>âš™ï¸ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª</h4>
        <ul>
            <li><b>Ø¥Ø¯Ø§Ø±Ø©:</b> Ù„Ø¥Ø¶Ø§ÙØ© Ø¯ÙƒØ§ØªØ±Ø©ØŒ Ù…Ø­Ø§Ø¶Ø±Ø§ØªØŒ Ø£Ùˆ "Ø¥Ø¯Ø§Ø±Ø© Ø³Ø§Ø¹Ø§Øª Ø§Ù„ÙØµÙˆÙ„".</li>
            <li><b>ÙØ±Ø²:</b> Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø§Ø¨ØªØ±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‡Ù…ÙŠØ© (Ø§Ù„ÙˆØ²Ù†).</li>
            <li><b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</b> ÙŠØ¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù… ØªÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯.</li>
            <li><b>Ø§Ù„Ù…ÙØ¶Ù„Ø© â­:</b> ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„ØªÙŠ Ù…ÙŠØ²ØªÙ‡Ø§ Ø¨Ù†Ø¬Ù…Ø©.</li>
        </ul>

        <h4>ğŸ“š Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙˆØ§Ù„Ø¬Ø§Ø¨ØªØ±Ø§Øª</h4>
        <ul>
            <li><b>Ø±Ø£Ø³ Ø§Ù„Ø¬Ø§Ø¨ØªØ±:</b> ÙŠØ¹Ø±Ø¶ Ù„Ùƒ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù‡Ù…Ø© (Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§ØªØŒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù†Ù‡Ø§ØŒ ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¬Ø§Ø¨ØªØ±ØŒ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù†Ù‡Ø§).</li>
            <li><b>â˜†/â­:</b> Ù„ØªÙ…ÙŠÙŠØ² Ù…Ø­Ø§Ø¶Ø±Ø© (ÙŠØªØºÙŠØ± Ø´ÙƒÙ„Ù‡Ø§ ÙÙˆØ±Ø§Ù‹).</li>
            <li><b>ğŸš«:</b> Ù„ØªØ¬Ø§Ù‡Ù„ Ù…Ø­Ø§Ø¶Ø±Ø© ÙˆØ¥Ø®Ø±Ø§Ø¬Ù‡Ø§ Ù…Ù† Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªÙ‚Ø¯Ù….</li>
            <li><b>ğŸ¬ ÙÙŠØ¯ÙŠÙˆ:</b> Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ Ø³ÙŠØ³Ø£Ù„Ùƒ Ø¹Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ù„Ø­Ø³Ø§Ø¨ "Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©".</li>
            <li><b>ğŸ“ Ù…Ù„Ø²Ù…Ø©:</b> ØªØ­Ø¯ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙŠØ¹ØªØ¨Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© "Ù…ÙƒØªÙ…Ù„Ø©" ÙˆÙŠØ¶ÙŠÙÙ‡Ø§ Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ù„ÙˆØ¨Ø±Ù†Øª.</li>
        </ul>
    </div>
    <div class="divider"></div>
    <div style="text-align: left;"> <button class="secondary" id="closeAboutModal">Ø¥ØºÙ„Ø§Ù‚</button> </div>
  </div>
</div>

<div class="modal-back" id="starredModal"> <div class="modal"> <h3>Ø§Ù„Ù…ÙØ¶Ù„Ø© â­</h3> <div id="starredContainer"></div> <div class="divider"></div> <div style="text-align: left;"> <button class="secondary" id="closeStarredModal">Ø¥ØºÙ„Ø§Ù‚</button> </div> </div> </div>


<script>
// --- Firebase Config & Init (No Change) ---
const firebaseConfig = { /* ... */ }; // Same as before
try { firebase.initializeApp(firebaseConfig); console.log("Firebase Initialized."); }
catch (e) { console.error("Firebase init failed:", e); }
const auth = firebase.auth(); const db = firebase.firestore(); const googleProvider = new firebase.auth.GoogleAuthProvider();

// --- App State (No Change) ---
let currentUser = null; let userId = null; let userDocRef = null;
let appData = {}; let state = {}; let activeSubjectName = null;
let examDate = ""; let totalStudyDays = 0; let isSorted = false;

// --- DOM Elements (No Change) ---
let mainAppContent, userSection, userImg, userName, loginBtn, logoutBtn, cardsEl, subjectSelector,
    daysRemainingEl, daysRemainingBox, datePickerInput, totalHoursEl, totalHoursBox,
    remainingHoursEl, remainingHoursBox,
    plannerStatusBox, planStatus, planLecturesPerDay, globalBar, globalBarPct,
    blueprintBarSpan, blueprintBarPct, headerTitle, addSubjectModal, addSubjectBtn,
    manageModalBack, remainingModalBack, planHoursPerDay, planStatusInfo, aboutModal,
    searchInput, starredModal;

// --- Default Data (No Change) ---
function getDefaultData() { /* ... */ } // Same as before

// --- Firestore Functions (No Change) ---
async function loadDataFromFirestore() { /* ... */ } // Same as before
async function saveAllDataToFirestore() { /* ... */ } // Same as before
async function saveAppData() { /* ... */ } // Same as before
async function saveProgress() { if (!userDocRef) return; try { await userDocRef.update({ state }); console.log("%cProg svd.", "color: lightblue;", JSON.parse(JSON.stringify(state))); } catch (e) { console.error("Err sv Prog:", e); } }
async function saveActiveSubject() { /* ... */ } // Same as before
async function saveExamDateAndDays(newD, newTD) { /* ... */ } // Same as before

// --- Calculation Functions (No Change) ---
function isLectureComplete(rec){ return !!rec?.notes; }
function computeGlobal(subName, subData){ /* ... */ } // Same as before


// --- Rendering Functions (No Change) ---
function renderGlobalHeader(subName, subData, computedGlobal){ /* ... */ } // Same as before
function render(subName, subData, searchTerm = "") { /* ... */ } // Same as before


/*
=============================================================================
=== âœ… FINAL REVISED LOGIC v4: updateEntry Function ===
1.  Simplify: Always call init() after any state change (video, notes, snooze).
2.  This guarantees UI and calculations are always based on the latest saved state.
3.  Keeps the prompt logic for video duration.
4.  Removes the complex `requiresPlanUpdate` logic.
=============================================================================
*/
async function updateEntry(subName, lec, rowEl, action){
    const k = `${subName}||${lec.chapter}||${lec.title}`;
    const rec = state[k] || {snoozed:!1, starred: !1, videoDuration: null};
    let shouldSave = true; // Assume save unless prompt fails/cancels

    console.log(`%c[${action}] START for "${lec.title}"`, "color: magenta; font-weight: bold;");
    console.log(`[${action}] Initial State:`, JSON.parse(JSON.stringify(rec)));

    // --- 1. Perform Action & Update State Object Directly ---
    if(action === 'video'){
        const isChecking = rowEl.querySelector('[data-action=video]').checked;
        const intendedVideoState = isChecking;

        // Prompt logic (only if checking and duration is missing)
        if (isChecking && (rec.videoDuration === null || rec.videoDuration === undefined)) {
            const durationInput = prompt(`ÙƒÙ… Ø³Ø§Ø¹Ø© Ø§Ø³ØªØºØ±Ù‚ ÙÙŠØ¯ÙŠÙˆ "${lec.title}"ØŸ`, "");
            if (durationInput !== null) { // Not cancelled
                const duration = parseFloat(durationInput);
                if (!isNaN(duration) && duration > 0) {
                    rec.videoDuration = duration;
                    rec.video = intendedVideoState; // Apply state change
                    console.log(`[${action}] Duration entered: ${duration}`);
                } else { // Invalid or empty input
                    alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ (Ù…Ø«Ù„ 1.5).");
                    rowEl.querySelector('[data-action=video]').checked = rec.video; // Revert UI
                    shouldSave = false;
                    console.log(`[${action}] Invalid duration input.`);
                }
            } else { // User cancelled prompt
                rowEl.querySelector('[data-action=video]').checked = rec.video; // Revert UI
                shouldSave = false;
                console.log(`[${action}] Duration prompt cancelled.`);
            }
        } else {
             // Duration exists or unchecking. Apply state change.
             rec.video = intendedVideoState;
        }
    }
    else if(action === 'notes'){
        rec.notes = rowEl.querySelector('[data-action=notes]').checked;
    }
    else if(action === 'snooze'){
        rec.snoozed = !rec.snoozed;
    }
    else if(action === 'star'){
        rec.starred = !rec.starred;
        const starBtn = rowEl.querySelector('.star-btn');
        if(starBtn) {
            starBtn.classList.toggle('active', rec.starred);
            starBtn.textContent = rec.starred ? 'â­' : 'â˜†';
        }
        // Starring doesn't require re-render/recalc
    }

    console.log(`[${action}] State after action:`, JSON.parse(JSON.stringify(rec)));
    console.log(`[${action}] Should Save: ${shouldSave}`);

    // --- 2. Save Block ---
    if (shouldSave) {
        state[k] = rec; // Update the global state object reference
        try {
            await saveProgress(); // Save the entire state object to Firestore
            console.log(`[${action}] Firestore save successful.`);

            // --- 3. THE FIX: Always Re-initialize UI After Save ---
            // Re-call init() ONLY for actions that affect calculations or visual state (not star)
            if (action !== 'star') {
                console.log(`[${action}] ---> Calling init() to refresh UI and calculations...`);
                // Find currently open cards BEFORE calling init() which clears them
                const openCardIds = [];
                 if (cardsEl) {
                    cardsEl.querySelectorAll('.card-content').forEach(contentEl => {
                        if (contentEl.style.display === 'grid') {
                            openCardIds.push(contentEl.id);
                        }
                    });
                 }
                init(); // Re-render everything based on the newly saved state

                // Restore open cards after init finishes rendering
                 setTimeout(() => {
                    openCardIds.forEach(cardId => {
                        const contentEl = document.getElementById(cardId);
                        if (contentEl) {
                            contentEl.style.display = 'grid';
                            console.log(`[${action}] ---> Re-opened card ${cardId}`);
                        }
                    });
                 }, 0); // Use timeout 0 to run after current execution stack

            } else {
                 console.log(`[${action}] ---> Skipping init() call (only starring).`);
            }
            // --- End of Fix ---

        } catch (e) {
             console.error(`[${action}] Firestore save failed:`, e);
             // Maybe alert user? For now, UI might be inconsistent with DB.
        }
    } else {
         console.log(`[${action}] Firestore save skipped. No UI refresh.`);
    }

    // --- UI update for row colors is now handled by init() ---

    console.log(`%c[${action}] END for "${lec.title}"`, "color: magenta; font-weight: bold;");
}


// --- Planning Functions (No Change) ---
function getDaysRemaining(targetDate = examDate) { /* ... */ } // Same as before
function calculateAndDisplayDays() { /* ... */ } // Same as before
function updateDynamicPlan() { /* ... */ } // Same as before


// --- Modal Functions (No Change) ---
function openAddSubjectModal() { /* ... */ } // Same as before
function closeAddSubjectModal() { /* ... */ } // Same as before
function handleSaveNewSubject() { /* ... */ } // Same as before
async function handleSaveChapterHours(e) { /* ... */ } // Same as before
function openManageModal() { /* ... */ } // Same as before
function handleAddDoctor() { /* ... */ } // Same as before
function handleBulkAddLectures() { /* ... */ } // Same as before
function setupRemainingModal() { /* ... */ } // Same as before
function setupStarredModal() { /* ... */ } // Same as before

// --- Auth Functions (No Change) ---
async function signInWithGoogle() { /* ... */ } // Same as before
async function signOutUser() { /* ... */ } // Same as before

// --- Reset Function (No Change) ---
async function resetAllData() { /* ... */ } // Same as before

// --- Initialization Function (MODIFIED slightly for card restore) ---
function init(openCardIds = []){ // Accept optional list of card IDs to reopen
    console.log("%cinit() called.", "color: green; font-weight: bold;");
    if (!currentUser) { console.warn("Cannot init, user not logged in."); return; }
    const subjectKeys = Object.keys(appData);
    if (subjectKeys.length === 0) {
        render(null, null);
        subjectSelector.innerHTML = '<option>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯</option>';
    } else {
        if (!activeSubjectName || !appData[activeSubjectName]) {
            activeSubjectName = subjectKeys[0];
        }
        subjectSelector.innerHTML = '';
        subjectKeys.forEach(subName => {
            const opt=document.createElement('option');opt.value=subName;opt.textContent=subName;if(subName===activeSubjectName)opt.selected=true; subjectSelector.appendChild(opt);
        });
        // Pass openCardIds to render function
        render(activeSubjectName, appData[activeSubjectName], searchInput ? searchInput.value : "");
    }
    calculateAndDisplayDays();
    updateDynamicPlan();

    console.log("%cinit() finished.", "color: green; font-weight: bold;");
}


// --- Clock Function (No Change) ---
function updateClock() { /* ... */ } // Same as before
function startClock() { /* ... */ } // Same as before

// --- Event Listeners Setup (No Change) ---
document.addEventListener('DOMContentLoaded', () => { /* ... */ }); // Same as before

</script>
</body>
</html>
